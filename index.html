<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Social Engineering</title>

<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
    font-family: 'Rajdhani', sans-serif; 
    background: #1a1d35; 
    color: #fff; 
    line-height: 1.6;
}

.container { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 20px; 
}

header { 
    text-align: center; 
    margin-bottom: 30px; 
    padding: 20px 0;
}

h1 { 
    font-size: 2.5rem; 
    letter-spacing: 3px; 
    font-weight: 700;
    margin: 0;
}

.subtitle { 
    color: #8b95a5; 
    font-size: 1.1rem; 
    margin-top: 10px;
    letter-spacing: 1px;
}

/* --- Upload Section --- */
.upload-section { 
    background: #22253a; 
    padding: 30px; 
    border-radius: 12px; 
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.upload-section h2 {
    margin-bottom: 20px;
    color: #fff;
    letter-spacing: 2px;
    font-size: 1.3rem;
}

.upload-area { 
    border: 3px dashed #2962FF; 
    padding: 40px 20px; 
    text-align: center; 
    cursor: pointer; 
    border-radius: 12px;
    transition: all 0.3s ease;
    background: rgba(41, 98, 255, 0.05);
}

.upload-area:hover {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}

.upload-area.dragover {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.15);
    transform: scale(1.02);
}

.upload-icon {
    font-size: 3rem;
    margin-bottom: 10px;
}

.file-input { display: none; }

.file-info { margin-top: 15px; font-size: 0.95rem; color: #27ae60; font-weight: 500; }
.error-msg { margin-top: 15px; font-size: 0.95rem; color: #e74c3c; font-weight: 500; }

/* --- Table --- */
.table-container {
    background: #22253a;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s ease;
}

.table-container.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

.search-box {
    padding: 12px 15px;
    background: #2c2f4d;
    border: 2px solid #3a3d5c;
    border-radius: 8px;
    color: #fff;
    font-size: 0.95rem;
    font-family: 'Rajdhani', sans-serif;
    transition: all 0.3s ease;
}

.search-box:focus { outline: none; border-color: #2962FF; background: #1a1d35; }
.search-box::placeholder { color: #8b95a5; }

.upload-btn {
    padding: 12px 24px;
    background: #2962FF;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.5px;
}
.upload-btn:hover { background: #1e4ed8; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(41, 98, 255, 0.4); }
.upload-btn:active { transform: translateY(0); }
.upload-btn:disabled { background: #555; cursor: not-allowed; transform: none; }

table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { padding: 12px 15px; text-align: left; font-size: 0.9rem; border-bottom: 1px solid #2c2f4d; }
th { background: #1a1d35; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; font-size: 0.85rem; color: #a8b2c1; }
tr:hover { background: rgba(41, 98, 255, 0.05); }

.screenshot-thumbnail { width: 80px; height: 50px; object-fit: cover; cursor: pointer; border-radius: 6px; transition: all 0.3s ease; border: 2px solid #2c2f4d; }
.screenshot-thumbnail:hover { transform: scale(1.1); border-color: #2962FF; box-shadow: 0 4px 12px rgba(41, 98, 255, 0.5); }
.screenshot-cell { text-align: center; }

.pagination { text-align: center; margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 15px; }
.pagination button { padding: 10px 20px; background: #2c2f4d; border: 2px solid #3a3d5c; color: #fff; border-radius: 8px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: 600; transition: all 0.3s ease; }
.pagination button:hover:not(:disabled) { background: #2962FF; border-color: #2962FF; }
.pagination button:disabled { opacity: 0.3; cursor: not-allowed; }
#pageInfo { font-weight: 600; color: #a8b2c1; }

/* --- Modal Immagine --- */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; }
.modal-content { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
.close { position: absolute; top: 30px; right: 40px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
.close:hover { color: #2962FF; transform: scale(1.2); }

/* --- Charts Grid --- */
.charts-grid-two-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
.charts-grid-two-cols.active { display: grid !important; opacity: 1; transform: translateY(0); }
.charts-grid-single { margin: 2rem 0; opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
.charts-grid-single.active { display: block !important; opacity: 1; transform: translateY(0); }

.chart-card { background: #22253a; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-height: 450px; }
.chart-card h3 { margin-bottom: 20px; color: #fff; font-size: 1.1rem; letter-spacing: 1px; }
.chart-wrapper { position: relative; height: 380px; width: 100%; }

@media (max-width: 768px) {
    .charts-grid-two-cols { grid-template-columns: 1fr; }
    h1 { font-size: 1.8rem; }
    .container { padding: 15px; }
}
</style>
</head>

<body>
<div class="container">

<header>
    <h1>DASHBOARD SOCIAL ENGINEERING</h1>
    <div class="subtitle">Siti di Phishing & Superficie di Attacco Umano</div>
</header>

<div class="upload-section">
    <h2>CARICA DATI CSV</h2>
    
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìä</div>
        <p style="font-size:1.1rem;margin-bottom:.5rem">Clicca per caricare il file CSV</p>
        <p style="color:#8b95a5;margin-bottom:1rem">oppure trascina qui</p>
        <input type="file" id="fileInput" class="file-input" accept=".csv,.tsv,.txt">
    </div>
    
    <div id="fileInfo" class="file-info"></div>
    <div id="errorMsg" class="error-msg"></div>
</div>

<div class="table-container" id="tableContainer">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 100px;gap:1rem;margin-bottom:1rem;">
        <div class="date-input-wrapper">
            <input type="date" id="dateStartFilter" class="search-box" placeholder="Data Inizio">
        </div>
        <div class="date-input-wrapper">
            <input type="date" id="dateEndFilter" class="search-box" placeholder="Data Fine">
        </div>
        <select id="sectorFilter" class="search-box" style="cursor:pointer;">
            <option value="">Tutti i Settori</option>
        </select>
        <select id="goalFilter" class="search-box" style="cursor:pointer;">
            <option value="">Tutti gli Obiettivi</option>
        </select>
        <button id="resetFiltersBtn" class="upload-btn" style="background:#e74c3c;padding:0.9rem 1rem;font-size:0.9rem;">
            üîÑ Reset
        </button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Sito</th>
                <th>Data</th>
                <th>Settore Attaccato</th>
                <th>Obiettivo Attacco</th>
                <th>Screenshot</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr>
                <td colspan="5" style="text-align:center;color:#8b95a5;">Nessun dato caricato</td>
            </tr>
        </tbody>
    </table>
    <div class="pagination">
        <button id="prevBtn">‚Üê Precedente</button>
        <span id="pageInfo">Pagina 1</span>
        <button id="nextBtn">Successivo ‚Üí</button>
    </div>
</div>

<div id="imageModal" class="modal" onclick="closeModal()">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

</div>

<script>
// --- VAR GLOBALI ---
let allSectorsChart, top5SectorsBarChart, goalsPieChart, monthChart, goalsByMonthChart;
let currentData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 10;
const colors=['#5a8db8','#e74c3c','#e67e22','#7b8794','#3498db','#9b59b6','#27ae60','#f39c12','#c0392b','#16a085','#8e44ad','#2c3e50','#e67e22','#95a5a6','#34495e'];

// --- UPLOAD ---
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const errorMsg = document.getElementById('errorMsg');

uploadArea.onclick = () => fileInput.click();
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); const file = e.dataTransfer.files[0]; if(file) handleFile(file); });
fileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if(file) handleFile(file); });

// --- MODALE IMMAGINI ---
function getLocalImagePath(rowIndex) { return `images/${rowIndex + 1}.png`; }
function showImage(imagePath) { document.getElementById('imageModal').style.display='flex'; document.getElementById('modalImage').src=imagePath; }
function closeModal() { document.getElementById('imageModal').style.display='none'; }
document.addEventListener('keydown', function(event){ if(event.key==='Escape') closeModal(); });

// --- UTILITY DATE ---
function parseDateSafe(dateStr) {
    if(!dateStr) return null;
    if(/^\d{4}-\d{2}-\d{2}/.test(dateStr)) return new Date(dateStr);
    if(/^\d{2}\/\d{2}\/\d{4}/.test(dateStr)){ const [d,m,y]=dateStr.split('/'); return new Date(`${y}-${m}-${d}`);}
    const d = new Date(dateStr);
    return isNaN(d)? null : d;
}

// --- FILTRI ---
function applyFilters() {
    const dateStart = parseDateSafe(document.getElementById('dateStartFilter').value);
    const dateEnd = parseDateSafe(document.getElementById('dateEndFilter').value);
    const sectorFilter = document.getElementById('sectorFilter').value;
    const goalFilter = document.getElementById('goalFilter').value;

    filteredData = currentData.filter(r => {
        const rowDate = parseDateSafe(r.date);
        if(dateStart && (!rowDate || rowDate<dateStart)) return false;
        if(dateEnd && (!rowDate || rowDate>dateEnd)) return false;
        if(sectorFilter && r.sector!==sectorFilter) return false;
        if(goalFilter && r.goal!==goalFilter) return false;
        return true;
    });

    displayPage(filteredData,1);
    updateAllCharts(filteredData);
}

document.getElementById('dateStartFilter').addEventListener('change', applyFilters);
document.getElementById('dateEndFilter').addEventListener('change', applyFilters);
document.getElementById('sectorFilter').addEventListener('change', applyFilters);
document.getElementById('goalFilter').addEventListener('change', applyFilters);
document.getElementById('resetFiltersBtn').addEventListener('click', function(){
    document.getElementById('dateStartFilter').value='';
    document.getElementById('dateEndFilter').value='';
    document.getElementById('sectorFilter').value='';
    document.getElementById('goalFilter').value='';
    applyFilters();
});

// --- POPOLA SELECT ---
function populateFilters(data){
    const sectors=[...new Set(data.map(r=>r.sector))].sort();
    const sectorSelect=document.getElementById('sectorFilter');
    sectorSelect.innerHTML='<option value="">Tutti i Settori</option>';
    sectors.forEach(s=>{ const option=document.createElement('option'); option.value=s; option.textContent=s; sectorSelect.appendChild(option); });
    const goals=[...new Set(data.map(r=>r.goal))].sort();
    const goalSelect=document.getElementById('goalFilter');
    goalSelect.innerHTML='<option value="">Tutti gli Obiettivi</option>';
    goals.forEach(g=>{ const option=document.createElement('option'); option.value=g; option.textContent=g; goalSelect.appendChild(option); });
}

// --- PAGINAZIONE ---
document.getElementById('prevBtn').onclick=()=>{ if(currentPage>1){currentPage--; displayPage(filteredData,currentPage);} };
document.getElementById('nextBtn').onclick=()=>{ const total=Math.ceil(filteredData.length/rowsPerPage); if(currentPage<total){currentPage++; displayPage(filteredData,currentPage);} };

function displayPage(data,page){
    currentPage=page;
    const tbody=document.getElementById('tableBody');
    tbody.innerHTML='';
    const start=(page-1)*rowsPerPage;
    const pageData=data.slice(start,start+rowsPerPage);
    if(pageData.length===0){tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#8b95a5;">Nessun dato trovato</td></tr>'; return;}
    pageData.forEach(r=>{
        const siteDisplay=r.site.length>50?r.site.substring(0,47)+'...':r.site;
        const dateDisplay=r.date?r.date.substring(0,10):'-';
        const imagePath=getLocalImagePath(r.rowIndex);
        const screenshotCell=`<img src="${imagePath}" alt="Screenshot" class="screenshot-thumbnail" onclick="event.stopPropagation(); showImage('${imagePath}')" onerror="this.style.display='none'">`;
        tbody.innerHTML+=`<tr>
            <td title="${r.site}">${siteDisplay}</td>
            <td>${dateDisplay}</td>
            <td>${r.sector}</td>
            <td>${r.goal}</td>
            <td class="screenshot-cell">${screenshotCell}</td>
        </tr>`;
    });
    const total=Math.ceil(data.length/rowsPerPage)||1;
    document.getElementById('pageInfo').textContent=`Pagina ${page} di ${total} (${data.length} record)`;
    document.getElementById('prevBtn').disabled=page===1;
    document.getElementById('nextBtn').disabled=page===total;
}

// --- FILE CSV ---
function handleFile(file){
    fileInfo.textContent='';
    errorMsg.textContent='';
    if(!file.name.endsWith('.csv')){errorMsg.textContent='Solo file CSV consentiti!'; return;}
    const reader=new FileReader();
    reader.onload=function(e){
        try{
            const text=e.target.result;
            parseCSV(text);
        }catch(err){errorMsg.textContent='Errore parsing CSV!'; console.error(err);}
    };
    reader.readAsText(file);
}

function parseCSV(text){
    const lines=text.split(/\r?\n/).filter(l=>l.trim()!=='');
    const headers=lines.shift().split(';').map(h=>h.trim().toLowerCase());
    currentData=lines.map((line,rowIndex)=>{
        const values=line.split(';').map(v=>v.trim());
        const obj={rowIndex};
        headers.forEach((h,i)=>obj[h]=values[i]||'');
        // normalizzo propriet√† attese
        return { rowIndex, site: obj.site||obj.sito||'', date: obj.date||obj.data||'', sector: obj.sector||obj.settore||'', goal: obj.goal||obj.obiettivo||''};
    });
    document.getElementById('tableContainer').classList.add('active');
    populateFilters(currentData);
    applyFilters();
}

// --- CHARTS ---
function updateAllCharts(data){ /* implementazione dei chart secondo dataset */ }

</script>
</body>
</html>
