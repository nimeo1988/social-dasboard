<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Engineering Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ====== STILI PRINCIPALI ====== */
body {
    font-family: 'Rajdhani', sans-serif;
    background:#0f111a;
    color:#f5f6fa;
    margin:0;
}
.container { max-width:1200px; margin:0 auto; padding:2rem; }
header { text-align:center; margin-bottom:2rem; }
header h1 { font-size:2rem; letter-spacing:2px; color:#fff; margin:0; }
header .subtitle { color:#8b95a5; font-size:1rem; margin-top:.5rem; }
.upload-section { background:#1e1f2a; padding:1.5rem; border-radius:10px; margin-bottom:2rem; }
.upload-area { border:2px dashed #444; padding:2rem; border-radius:10px; text-align:center; cursor:pointer; transition:0.3s; }
.upload-area:hover { background:#222; }
.file-input { display:none; }
.upload-btn { background:#3498db; border:none; color:#fff; padding:.8rem 1rem; border-radius:5px; cursor:pointer; transition:0.3s; }
.upload-btn:hover { background:#2980b9; }
table { width:100%; border-collapse:collapse; margin-bottom:1rem; }
table th, table td { padding:.8rem; border-bottom:1px solid #333; text-align:left; }
table th { background:#1e1f2a; }
.table-container { overflow-x:auto; }
.pagination { display:flex; justify-content:center; align-items:center; gap:.5rem; margin-top:1rem; }
.search-box { padding:.5rem; border-radius:5px; border:1px solid #333; background:#111; color:#fff; width:100%; }
.date-input-wrapper { display:flex; flex-direction:column; }
.error-msg { color:#e74c3c; margin-top:1rem; }
/* Loader per status */
.status-loader { font-size:0.8rem; color:#f39c12; }
.status-online { color:#2ecc71; font-weight:bold; }
.status-offline { color:#e74c3c; font-weight:bold; }
</style>
</head>
<body>
<div class="container">
<header>
    <h1>SOCIAL ENGINEERING DASHBOARD</h1>
    <div class="subtitle">Phishing Sites & Human Attack Surface</div>
</header>

<div class="upload-section">
    <h2>UPLOAD CSV DATA</h2>
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìä</div>
        <p style="font-size:1.1rem;margin-bottom:.5rem">Click to upload CSV file</p>
        <p style="color:#8b95a5;margin-bottom:1rem">or drag & drop here</p>
        <input type="file" id="fileInput" class="file-input" accept=".csv,.tsv,.txt">
    </div>
    <div id="fileInfo" class="file-info"></div>
    <div id="errorMsg" class="error-msg"></div>
</div>

<div class="table-container" id="tableContainer">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 100px;gap:1rem;margin-bottom:1rem;">
        <div class="date-input-wrapper">
            <input type="date" id="dateStartFilter" class="search-box" placeholder="Start Date">
        </div>
        <div class="date-input-wrapper">
            <input type="date" id="dateEndFilter" class="search-box" placeholder="End Date">
        </div>
        <select id="sectorFilter" class="search-box" style="cursor:pointer;">
            <option value="">All Sectors</option>
        </select>
        <select id="goalFilter" class="search-box" style="cursor:pointer;">
            <option value="">All Goals</option>
        </select>
        <button id="resetFiltersBtn" class="upload-btn" style="background:#e74c3c;padding:0.9rem 1rem;font-size:0.9rem;">
            üîÑ Reset
        </button>
    </div>

<div style="text-align:center;margin-bottom:1.5rem;">
    <button id="generatePdfBtn" class="upload-btn" style="background:#27ae60;">
        üìÑ Generate PDF Report
    </button>
</div>

<table>
    <thead>
        <tr>
            <th>Site</th>
            <th>Date</th>
            <th>Sector Attacked</th>
            <th>Attack Goal</th>
            <th>Screenshot</th>
            <th>Status</th> <!-- nuova colonna -->
        </tr>
    </thead>
    <tbody id="tableBody">
        <tr>
            <td colspan="6" style="text-align:center;color:#8b95a5;">No data loaded</td>
        </tr>
    </tbody>
</table>
<div class="pagination">
    <button id="prevBtn">‚Üê Previous</button>
    <span id="pageInfo">Page 1</span>
    <button id="nextBtn">Next ‚Üí</button>
    <span style="margin-left: 20px;">
        <label for="jumpPage" style="color: #a8b2c1;">Jump to page:</label>
        <input type="number" id="jumpPage" min="1" max="1" style="width:60px;text-align:center;">
        <button id="jumpBtn" class="upload-btn" style="background:#9b59b6;">Go</button>
    </span>
</div>
</div>

<script>
// ===== Variabili globali =====
let csvData = [];
let currentPage = 1;
const rowsPerPage = 10;

// ===== Upload CSV =====
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', e => e.preventDefault());
uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    if(e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files;
    handleFile(fileInput.files[0]);
});
fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

function handleFile(file){
    if(!file) return;
    if(!file.name.match(/\.(csv|tsv|txt)$/i)){
        document.getElementById('errorMsg').textContent = "Invalid file type!";
        return;
    }
    document.getElementById('errorMsg').textContent = "";
    const reader = new FileReader();
    reader.onload = e => {
        const text = e.target.result;
        parseCSV(text);
    }
    reader.readAsText(file);
}

// ===== Parse CSV =====
function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    const headers = lines[0].split(/,|;/).map(h => h.trim().toLowerCase());
    csvData = lines.slice(1).map(line => {
        const values = line.split(/,|;/);
        let obj = {};
        headers.forEach((h,i)=> obj[h] = values[i] || '');
        obj.status = 'checking'; // inizialmente checking
        return obj;
    });
    populateFilters();
    checkAllOnlineStatus();
}

// ===== Popola filtri =====
function populateFilters(){
    const sectorSet = new Set(csvData.map(d=>d.sector_attacked));
    const goalSet = new Set(csvData.map(d=>d.attack_goal));
    const sectorFilter = document.getElementById('sectorFilter');
    const goalFilter = document.getElementById('goalFilter');
    sectorFilter.innerHTML = '<option value="">All Sectors</option>';
    goalFilter.innerHTML = '<option value="">All Goals</option>';
    sectorSet.forEach(s=>{if(s)s && sectorFilter.append(new Option(s,s));});
    goalSet.forEach(g=>{if(g)goalFilter.append(new Option(g,g));});
}

// ===== Controlla status online/offline =====
async function checkAllOnlineStatus(){
    for(let i=0;i<csvData.length;i++){
        displayPage(csvData, currentPage); // mostra loader
        const site = csvData[i].site;
        try {
            const res = await fetch(`/api/checkOnline?site=${encodeURIComponent(site)}`);
            const data = await res.json();
            csvData[i].status = data.online ? 'online' : 'offline';
        } catch(e){
            csvData[i].status = 'offline';
        }
        displayPage(csvData, currentPage);
    }
}

// ===== Mostra tabella paginata =====
function displayPage(data, page){
    currentPage = page;
    const sortedData = [...data].sort((a, b) => {
        if (!a.date || !b.date) return 0;
        return b.date.localeCompare(a.date);
    });

    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    const start = (page - 1) * rowsPerPage;
    const pageData = sortedData.slice(start, start + rowsPerPage);

    if(pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#8b95a5;">No data found</td></tr>';
        return;
    }

    pageData.forEach(r => {
        const tr = document.createElement('tr');

        const siteCell = document.createElement('td');
        siteCell.textContent = r.site || '';
        tr.appendChild(siteCell);

        const dateCell = document.createElement('td');
        dateCell.textContent = r.date || '';
        tr.appendChild(dateCell);

        const sectorCell = document.createElement('td');
        sectorCell.textContent = r.sector_attacked || '';
        tr.appendChild(sectorCell);

        const goalCell = document.createElement('td');
        goalCell.textContent = r.attack_goal || '';
        tr.appendChild(goalCell);

        const screenshotCell = document.createElement('td');
        screenshotCell.textContent = r.screenshot || '';
        tr.appendChild(screenshotCell);

        const statusCell = document.createElement('td');
        if(r.status === 'checking'){
            statusCell.innerHTML = '<span class="status-loader">Checking...</span>';
        } else if(r.status === 'online'){
            statusCell.innerHTML = '<span class="status-online">Online</span>';
        } else {
            statusCell.innerHTML = '<span class="status-offline">Offline</span>';
        }
        tr.appendChild(statusCell);

        tbody.appendChild(tr);
    });

    // Aggiorna paginazione
    document.getElementById('pageInfo').textContent = `Page ${currentPage}`;
}

// ===== Paginazione =====
document.getElementById('prevBtn').addEventListener('click',()=>{if(currentPage>1) displayPage(csvData,currentPage-1);});
document.getElementById('nextBtn').addEventListener('click',()=>{const maxPage = Math.ceil(csvData.length/rowsPerPage); if(currentPage<maxPage) displayPage(csvData,currentPage+1);});
document.getElementById('jumpBtn').addEventListener('click',()=>{
    const jump = parseInt(document.getElementById('jumpPage').value);
    if(jump && jump>0 && jump<=Math.ceil(csvData.length/rowsPerPage)) displayPage(csvData,jump);
});
document.getElementById('resetFiltersBtn').addEventListener('click',()=>{document.getElementById('sectorFilter').value=''; document.getElementById('goalFilter').value=''; displayPage(csvData,1);});

</script>
</body>
</html>
